### Understanding
FTP, or File Transfer Protocol, is a widely used network protocol for<mark style="background: #FF5582A6;"> efficient and secure file exchange</mark> between a client and a server over a computer network, it operates on port <mark style="background: #FF5582A6;">21</mark> by default.

It operates through various modes and channels, including active mode, passive mode, and channels mode.

- <mark style="background: #FF5582A6;">Active mode</mark> requires the client to initiate a connection to the server, enabling direct communication.
- <mark style="background: #FF5582A6;">Passive mode</mark> is advantageous when the client is behind a firewall, as it allows the server to respond to the client's connection request.
- <mark style="background: #FF5582A6;">Channels mode</mark> allows multiple file transfer channels to be established simultaneously, improving efficiency.

<mark style="background: #BBFABBA6;">FTP offers several advantages</mark>:
- Reliable file transfer mechanism.
- Support for large file sizes and directory structures.
- Wide compatibility with various operating systems and platforms.
- User authentication and access control for enhanced security.

However, <mark style="background: #BBFABBA6;">FTP also has certain drawbacks</mark>:
- Potential security vulnerabilities, such as clear-text transmission of usernames and passwords if not properly secured.
- Limited support for encryption, which can expose data to interception or tampering.
- Lack of built-in mechanisms for error recovery or resumption of interrupted transfers.

### Enumerating

**Method**

1. Identify an FTP server that permits<mark style="background: #FF5582A6;"> anonymous login</mark>.
2. Connect to the FTP server using an FTP client. Use the following syntax:
    - Command: `ftp <hostname>`
    - Example: `ftp ftp.example.com`
3. Provide "anonymous" as the username during the login process.
4. Typically, no password is required. If prompted, enter an email address as the password.
5. Once logged in, browse the directories and files accessible to anonymous users.
6. Download desired files or upload potentially malicious content, depending on the server's permissions.
7. Exploit any vulnerabilities or access sensitive information within the accessible directories.

**Resources**

As we're going to be logging in to an FTP server, we will need to make sure an FTP client is installed on the system. There should be one installed by default on most Linux operating systems, such as Kali or Parrot OS. We can test if there is one by typing "ftp" into the console. If we're brought to a prompt that says: "ftp>", then we have a working FTP client on our system. If not, it's a simple matter of using "sudo apt install ftp" to install one.  

**Alternative Enumeration Methods**

It's worth noting  that some vulnerable versions of in.ftpd and some other FTP server variants return different responses to the "<mark style="background: #BBFABBA6;">cwd</mark>" command for home directories which exist and those that don’t. This can be exploited because we can issue cwd commands before authentication, and if there's a home directory- there is more than likely a user account to go with it. While this bug is found mainly within legacy systems, it's worth knowing about, as a way to exploit FTP.  

This vulnerability is documented at: [https://www.exploit-db.com/exploits/20745](https://www.exploit-db.com/exploits/20745)
### Exploiting

**Anonymous login**
_anonymous : anonymous
anonymous :
ftp : ftp
**Brute force**
Here we can find a nice list with default ftp credentials: [https://github.com/danielmiessler/SecLists/blob/master/Passwords/Default-Credentials/ftp-betterdefaultpasslist.txt](https://github.com/danielmiessler/SecLists/blob/master/Passwords/Default-Credentials/ftp-betterdefaultpasslist.txt)

**Browser connection**

We can connect to a FTP server using a browser (like Firefox) using a URL like:

ftp://anonymous:anonymous@10.10.10.98

Note that if a **web application** is sending data controlled by a user **directly to a FTP server** you can send <mark style="background: #BBFABBA6;">double URL encode</mark> `%0d%0a` (in double URL encode this is `%250d%250a`) bytes and make the **FTP server perform arbitrary actions**. One of this possible arbitrary actions is to download content from a users controlled server, perform port scanning or try to talk to other plain-text based services (like http).

**Some FTP commands**

```bash
- **`USER username`**
    
- **`PASS password`**
    
- **`HELP`** The server indicates which commands are supported
    
- **`PORT 127,0,0,1,0,80`**This will indicate the FTP server to establish a connection with the IP 127.0.0.1 in port 80 (_you need to put the 5th char as "0" and the 6th as the port in decimal or use the 5th and 6th to express the port in hex_).
    
- **`EPRT |2|127.0.0.1|80|`**This will indicate the FTP server to establish a TCP connection (_indicated by "2"_) with the IP 127.0.0.1 in port 80. This command **supports IPv6**.
    
- **`LIST`** This will send the list of files in current folder
    
    - **`LIST -R`** List recursively (if allowed by the server)

- **`APPE /path/something.txt`** This will indicate the FTP to store the data received from a **passive** connection or from a **PORT/EPRT** connection to a file. If the filename exists, it will append the data.
    
- **`STOR /path/something.txt`** Like `APPE` but it will overwrite the files
    
- **`STOU /path/something.txt`** Like `APPE`, but if exists it won't do anything.
    
- **`RETR /path/to/file`** A passive or a port connection must be establish. Then, the FTP server will send the indicated file through that connection
    
- **`REST 6`** This will indicate the server that next time it send something using `RETR` it should start in the 6th byte.
    
- **`TYPE i`** Set transfer to binary
    
- **`PASV`** This will open a passive connection and will indicate the user were he can connects
    
- **`PUT /tmp/file.txt`** Upload indicated file to the FTP
```

**Post-Exploitation**

The default configuration of vsFTPd can be found in `/etc/vsftpd.conf`. In here, you could find some dangerous settings:

- `anonymous_enable=YES`
    

- `anon_upload_enable=YES`
    

- `anon_mkdir_write_enable=YES`
    

- `anon_root=/home/username/ftp` - Directory for anonymous.
    

- `chown_uploads=YES` - Change ownership of anonymously uploaded files
    

- `chown_username=username` - User who is given ownership of anonymously uploaded files
    

- `local_enable=YES` - Enable local users to login
    

- `no_anon_password=YES` - Do not ask anonymous for password
    

- `write_enable=YES` - Allow commands: STOR, DELE, RNFR, RNTO, MKD, RMD, APPE, and SITE

